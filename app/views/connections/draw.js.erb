$("#draw_connections_link_<%= @server.id %> button").html('<span class="glyphicon glyphicon-random" aria-hidden="true"></span>')
$("#draw_connections_link_<%= @server.id %> button").toggleClass('btn-warning')

var activated_servers = activated_servers || {}

if (exists(activated_servers[<%= @server.id %>])) { // TOGGLE
    console.log("DELETE LINES")
    delete_lines(<%= @server.id %>)
} else {
    console.log("CREATE LINES")
    create_lines('<%= @server.id %>')
}

function create_lines(server_id) {
    <% @server.ports.each do |port| %>
    <% if port.paired_connection.present? %>
      draw_connection(server_id,
          '<%= port.id %>',
          '<%= port.paired_connection.port_id %>',
          '<%= port.cable_color %>',
          '<%= port.cable_name %>'
      )
    <% end %>
    <% end %>
    create_links_to_twin_cards()
}

function create_links_to_twin_cards() {
    <% @server.cards.each do |card| %>
      <% if card.twin_card_id.present? %>
        <% twin_card_ports = Port.where(card_id: card.twin_card_id) %>
        <% card.ports.each do |port| %>
          <% if port.connection.present? %>
            <% twin_card_port = twin_card_ports.select{|p| p.position == port.position}.first %>
            draw_connection('<%= @server.id %>',
                '<%= port.id %>',
                '<%= twin_card_port.id %>',
                '<%= port.cable_color %>',
                '<%= port.cable_name %>'
            )
          <% end %>
        <% end %>
      <% end %>
    <% end %>
}

function draw_connection(server_id, port_id, destination_port_id, cable_color, cable_name){
    let elt_start, elt_end
    elt_start = document.getElementById(port_id)
    elt_end = document.getElementById(destination_port_id)
    if (exists(elt_start) && exists(elt_end)) {
        create_line(server_id, port_id, elt_start, elt_end, cable_color, cable_name)
    }
}

function create_line(server_id, port_id, elt_start, elt_end, cable_color, cable_name) {
    activated_servers[server_id] = activated_servers[server_id] || {}

    var line = new LeaderLine(
        elt_start,
        elt_end,
        {
            color: colors_hash[cable_color],
            size: 2,
            middleLabel: cable_name,
            endPlug: 'behind',
            endSocket: 'auto',
            path: 'fluid', //'fluid',
            hide: true
        }
    )

    var ports_elts = [elt_start, elt_end]
    ports_elts.forEach(function (elem) {
        elem.addEventListener('mouseenter', function () {
            set_line_options(line, 'hover')
            outline_elements(ports_elts, true)
        }, false)
    })
    ports_elts.forEach(function (elem) {
        elem.addEventListener('mouseleave', function () {
            set_line_options(line, 'leave')
            outline_elements(ports_elts, false)
        }, false);
    })

    line.show()
    activated_servers[server_id][port_id] = activated_servers[server_id][port_id] || []
    activated_servers[server_id][port_id].push(line)
}

function set_line_options(line, status) {
    if (status === 'hover') {
        line.dash = {animation: true}
        line.size = 4
        // line.startPlug = 'square'
        // line.endPlug = 'square'
        // line.startPlugColor = '#f0ad4e'
        // line.endPlugColor = '#f0ad4e'
    } else {
        line.dash = false
        line.size = 2
        // line.startPlug = 'behind'
        // line.endPlug = 'behind'
    }
}

function outline_elements(elts, status) {
    elts.forEach(function (elt) {
        if (status) {
            $(elt).addClass('outlined')
        } else {
            $(elt).removeClass('outlined')
        }
    })
}

function delete_lines(server_id) {
    var ports = activated_servers[server_id]
    for (var key of Object.keys(ports)) {
        ports[key].forEach(function (line){
            line.hide()
            delete line
        })
        delete ports[key]
    }
    delete activated_servers[server_id]
}
